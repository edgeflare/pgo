-- benchmark table
CREATE TABLE IF NOT EXISTS transactions (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id TEXT REFERENCES iam.users(sub) ON DELETE CASCADE,
    transaction_date TIMESTAMPTZ NOT NULL,
    amount DECIMAL(10,2) NOT NULL,
    transaction_type VARCHAR(20) NOT NULL,
    category VARCHAR(50) NOT NULL,
    merchant_name VARCHAR(100),
    payment_method VARCHAR(30) NOT NULL,
    status VARCHAR(20) NOT NULL,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

-- indexes for better query performance
CREATE INDEX idx_user_id ON transactions(user_id);
CREATE INDEX idx_transaction_date ON transactions(transaction_date);
CREATE INDEX idx_amount ON transactions(amount);
CREATE INDEX idx_status ON transactions(status);
CREATE INDEX idx_category ON transactions(category);

-- GRANT and Row Level Security (RLS)
GRANT SELECT,INSERT,UPDATE,DELETE ON transactions TO authn;

-- RLS
ALTER TABLE transactions ENABLE ROW LEVEL SECURITY;

CREATE POLICY insert_own_tx ON transactions FOR INSERT
WITH CHECK (user_id = iam.user_jwt_sub());

CREATE POLICY select_own_tx ON transactions FOR SELECT
USING (user_id = iam.user_jwt_sub());

CREATE POLICY update_own_tx ON transactions FOR UPDATE
USING (user_id = iam.user_jwt_sub())
WITH CHECK (user_id = iam.user_jwt_sub());

CREATE POLICY delete_own_tx ON transactions FOR DELETE
USING (user_id = iam.user_jwt_sub());

CREATE INDEX IF NOT EXISTS idx_transactions_user_id ON transactions(user_id);

-- mock data
INSERT INTO transactions (transaction_date, amount, transaction_type, category, merchant_name, payment_method, status, user_id) VALUES
('2025-05-15 10:23:45', 89.99, 'debit', 'groceries', 'Fresh Market Plus', 'credit_card', 'completed', 
 (SELECT sub FROM iam.users ORDER BY random() LIMIT 1)),
('2025-05-15 11:45:22', 1250.00, 'credit', 'salary', 'TechCorp Inc', 'bank_transfer', 'completed',
 (SELECT sub FROM iam.users ORDER BY random() LIMIT 1)),
('2025-05-15 14:12:33', 45.50, 'debit', 'entertainment', 'Cinema World', 'debit_card', 'completed',
 (SELECT sub FROM iam.users ORDER BY random() LIMIT 1)),
('2025-05-16 09:30:15', 12.99, 'debit', 'subscription', 'StreamFlix', 'credit_card', 'completed',
 (SELECT sub FROM iam.users ORDER BY random() LIMIT 1)),
('2025-05-16 16:45:12', 299.99, 'debit', 'electronics', 'TechZone Store', 'credit_card', 'pending',
 (SELECT sub FROM iam.users ORDER BY random() LIMIT 1)),
('2025-05-17 08:15:44', 75.00, 'debit', 'gas', 'QuickFuel Station', 'debit_card', 'completed',
 (SELECT sub FROM iam.users ORDER BY random() LIMIT 1)),
('2025-05-17 12:22:18', 2500.00, 'credit', 'freelance', 'Design Studio LLC', 'bank_transfer', 'completed',
 (SELECT sub FROM iam.users ORDER BY random() LIMIT 1)),
('2025-05-17 19:33:27', 156.78, 'debit', 'dining', 'Italian Bistro', 'credit_card', 'completed',
 (SELECT sub FROM iam.users ORDER BY random() LIMIT 1)),
('2025-05-18 07:45:33', 89.99, 'debit', 'utilities', 'PowerGrid Electric', 'auto_pay', 'completed',
 (SELECT sub FROM iam.users ORDER BY random() LIMIT 1)),
('2025-05-18 13:28:45', 34.99, 'debit', 'groceries', 'Corner Market', 'debit_card', 'completed',
 (SELECT sub FROM iam.users ORDER BY random() LIMIT 1)),
('2025-05-19 10:15:22', 450.00, 'debit', 'rent', 'Sunset Apartments', 'bank_transfer', 'completed',
 (SELECT sub FROM iam.users ORDER BY random() LIMIT 1)),
('2025-05-19 15:42:18', 28.50, 'debit', 'coffee', 'Bean There Cafe', 'mobile_pay', 'completed',
 (SELECT sub FROM iam.users ORDER BY random() LIMIT 1)),
('2025-05-20 09:12:35', 199.99, 'debit', 'clothing', 'Fashion Forward', 'credit_card', 'failed',
 (SELECT sub FROM iam.users ORDER BY random() LIMIT 1)),
('2025-05-20 14:33:47', 67.89, 'debit', 'groceries', 'Organic Foods Co', 'debit_card', 'completed',
 (SELECT sub FROM iam.users ORDER BY random() LIMIT 1)),
('2025-05-21 11:25:12', 125.00, 'debit', 'healthcare', 'City Medical Center', 'credit_card', 'completed',
 (SELECT sub FROM iam.users ORDER BY random() LIMIT 1)),
('2025-05-21 16:18:33', 3200.00, 'credit', 'bonus', 'MegaCorp Industries', 'bank_transfer', 'completed',
 (SELECT sub FROM iam.users ORDER BY random() LIMIT 1)),
('2025-05-22 08:45:27', 15.99, 'debit', 'subscription', 'Music Stream Pro', 'credit_card', 'completed',
 (SELECT sub FROM iam.users ORDER BY random() LIMIT 1)),
('2025-05-22 13:22:15', 89.50, 'debit', 'dining', 'Sushi Express', 'mobile_pay', 'completed',
 (SELECT sub FROM iam.users ORDER BY random() LIMIT 1)),
('2025-05-23 10:33:48', 234.67, 'debit', 'shopping', 'Department Store', 'credit_card', 'pending',
 (SELECT sub FROM iam.users ORDER BY random() LIMIT 1)),
('2025-05-23 17:15:22', 42.99, 'debit', 'transportation', 'Metro Transit', 'mobile_pay', 'completed',
 (SELECT sub FROM iam.users ORDER BY random() LIMIT 1)),
('2025-05-24 09:28:14', 899.99, 'debit', 'electronics', 'Gadget World', 'credit_card', 'completed',
 (SELECT sub FROM iam.users ORDER BY random() LIMIT 1)),
('2025-05-24 14:42:33', 156.00, 'debit', 'utilities', 'Water Works Inc', 'auto_pay', 'completed',
 (SELECT sub FROM iam.users ORDER BY random() LIMIT 1)),
('2025-05-25 11:15:45', 78.90, 'debit', 'groceries', 'Budget Foods', 'debit_card', 'completed',
 (SELECT sub FROM iam.users ORDER BY random() LIMIT 1)),
('2025-05-25 16:33:22', 299.00, 'debit', 'fitness', 'GymLife Membership', 'bank_transfer', 'completed',
 (SELECT sub FROM iam.users ORDER BY random() LIMIT 1)),
('2025-05-26 08:22:18', 1875.00, 'credit', 'salary', 'StartupTech Ltd', 'bank_transfer', 'completed',
 (SELECT sub FROM iam.users ORDER BY random() LIMIT 1));